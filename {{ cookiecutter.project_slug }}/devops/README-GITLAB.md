# DevOps pipelines in GitLab CI/CD üöÄ

Welcome to the DevOps pipelines guide for deploying your project using GitLab pipelines!
This README provides step-by-step instructions to set up your GitLab repository and initiate manual deployment pipelines.
Follow each step carefully to correctly configure your environment and secrets.

## Repository setup üõ†Ô∏è

See [Get started with GitLab CI/CD](https://docs.gitlab.com/ee/ci/).

### Step 1: Add the deployment environment variables

1.  Visit [GitLab](https://gitlab.com/), or your organization's GitLab instance, and log in with your credentials.
2.  Go to your repository at [{{ cookiecutter.github_organization }}/{{ cookiecutter.project_slug }}](https://gitlab.com/{{ cookiecutter.github_organization }}/{{ cookiecutter.project_slug }}).
    Note that you might need to adjust the URL's host name to your organization's.
3.  Click on `Settings` at the left menu and select `CI/CD`.
4.  Expand the `Variables`.
5.  Add all variables and their corresponding values, copying them from the `.env` file.
    This file is not commited into the repository, and that's why we need to add them here.

### Step 2: Add deployment's host SSH key as a known host

1.  Run `ssh-keyscan -t ed25519 DEPLOY_HOST` in a terminal, where you substitute `DEPLOY_HOST` with the address of the host, as in the `.env` file.
2.  Copy the prompted value, and add it as a `Variable` in the GitLab web interface, like in the previous step.
    Name the variable `SSH_KNOWN_HOSTS`.

See [Use SSH keys to communicate with GitLab](https://docs.gitlab.com/ee/user/ssh.html).

### Step 3: Add an SSH deployment key

1.  Create a new SSH key that will be used by GitLab CI/CD to connect to your host.
    You can create it in your terminal with the command `ssh-keygen -t ed25519`.
2.  Copy the public key to the `DEPLOY_HOST`'s user's `~/.ssh/authorized_keys` file.
    Check your `DEPLOY_HOST` and `DEPLOY_USER` in the `.env` file.
3.  Copy the private key as a `Variable` like in the previous step.
    Name the variable `DEPLOY_SSH_PRIVATE_KEY`.

*Note:* instead of creating a new key, you can use the one that this template creates for you when you run `make server-setup`.
Check the section "Server Setup" in the file `README.md` in the same folder as this file for details.
Be aware that the key generated by this template will not be added to your git repository because it is explicitly excluded by the `.gitignore` file.

## Automatic deployment üöÄ

The deployment is executed automatically on each commit to `main` branch.

You may want to adapt your development workflow to that, and use a `develop` branch to develop and create merge requests for deployments.

## Manual deployment üöÄ

If you want to do manual deployments, you can enable the `when: manual` option of the `.gitlab-ci.yml` file.
By default it is commented.

## Deployment with an auxiliary docker image

The provided configuration tries to mimic the `Makefile` deployment flow.
It uses the same commands as you would use when deploying from your computer.

If you want, you can use an [auxiliary docker image](https://github.com/kitconcept/docker-stack-deploy/), which does the deployment for you instead of using the `Makefile`.
This Docker image is used if you configure the deployments in GitHub.

Check the commented section of the `.gitlab-ci.yml` file for an example.
